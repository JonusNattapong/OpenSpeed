<file_path>
OpenSpeed\.github\workflows\deploy-docs.yml
</file_path>

<edit_description>
Create a GitHub Actions workflow to build and deploy Jekyll docs with just-the-docs theme to GitHub Pages
</edit_description>
name: Deploy Docs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Grant minimal permissions required for deployment.
# - `pages: write` is required so the workflow can publish to GitHub Pages.
# - `contents: read` is sufficient for checking out repository contents.
# - `id-token: write` enables certain actions that may require OIDC (kept for future compatibility).
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        # Ensure the checkout action persists credentials so the GITHUB_TOKEN
        # can be used by subsequent steps (for pushing to gh-pages).
        persist-credentials: true
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
    - name: Install system build dependencies, Ruby gems and print debug info
      run: |
        set -eux
        # Move into docs directory for subsequent steps
        cd docs

        # Install native build dependencies required by some gems (e.g., nokogiri, openssl extensions)
        # Use apt-get; on GitHub Actions Ubuntu runners this will work.
        echo "=== Apt update & install native build deps ==="
        sudo apt-get update -y
        sudo apt-get install -y build-essential libssl-dev zlib1g-dev libreadline-dev libyaml-dev libxml2-dev libxslt1-dev libgmp-dev pkg-config

        # Print environment diagnostics
        echo "=== ruby & gem versions ==="
        ruby --version || true
        gem --version || true
        echo "=== PATH ==="
        echo "$PATH"

        echo "=== Working directory content ==="
        ls -la

        echo "=== Show Gemfile and Gemfile.lock if present ==="
        [ -f Gemfile ] && sed -n '1,200p' Gemfile || echo "No Gemfile"
        [ -f Gemfile.lock ] && sed -n '1,200p' Gemfile.lock || echo "No Gemfile.lock"

        # Ensure bundler is available (install if necessary)
        gem install bundler --no-document || true

        # Use a local vendor/bundle to avoid permission issues
        bundle config set --local path 'vendor/bundle'

        # Install gems with verbose output to capture errors
        bundle install --jobs 4 --retry 3 --verbose

        echo "=== Bundler list ==="
        bundle list || gem list
    - name: Build with Jekyll (verbose + diagnostics)
      run: |
        set -eux
        cd docs
        echo "=== Jekyll config ==="
        sed -n '1,200p' _config.yml || true
        echo "=== Jekyll version & environment ==="
        bundle exec jekyll -v || true
        echo "=== Node/npm info (if present) ==="
        node --version || true
        npm --version || true
        echo "=== Pre-build sanity: list docs dir ==="
        ls -la
        echo "=== Running Jekyll build with --trace for detailed errors ==="
        # Use --trace to get full Ruby backtrace on error; include destination explicitly
        bundle exec jekyll build --destination ./_site --trace || ( echo "Jekyll build failed, printing _site contents (if any)"; ls -la ./_site || true; false )
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/_site
        # include a clear commit message for traceability and allow empty commit if no changes
        commit_message: "chore(docs): deploy site from ${GITHUB_SHA}"
        allow_empty_commit: true
